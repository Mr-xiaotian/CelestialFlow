# test_manage.py

æœ¬æ–‡ä»¶ç”¨äºæµ‹è¯• CelestialFlow æ¡†æ¶ä¸­ **TaskManager** çš„åŸºæœ¬åŠŸèƒ½ä¸è¿è¡Œæ¨¡å¼ã€‚

**TaskManager** æ˜¯ CelestialFlow æ¡†æ¶ä¸­æœ€åŸºç¡€çš„ä»»åŠ¡æ‰§è¡Œå•å…ƒï¼Œåœ¨æœ¬æµ‹è¯•ä¸­ï¼Œå®ƒä»¥**ç‹¬ç«‹è¿è¡Œæ¨¡å¼ï¼ˆStandalone Modeï¼‰**è¿è¡Œï¼Œä¸ä½œä¸ºèŠ‚ç‚¹è¢«åµŒå…¥åˆ° **TaskGraph** ä¸­çš„â€œstage æ¨¡å¼â€ä¸åŒã€‚

åœ¨ç‹¬ç«‹æ¨¡å¼ä¸‹ï¼ŒTaskManager è‡ªè¡Œè´Ÿè´£ä»»åŠ¡è°ƒåº¦ã€å¼‚å¸¸é‡è¯•ã€è®¡æ•°ä¸å¹¶å‘æ§åˆ¶ï¼Œæ— éœ€ä¾èµ–å›¾ç»“æ„å³å¯å®Œæˆå®Œæ•´çš„ä»»åŠ¡ç”Ÿå‘½å‘¨æœŸç®¡ç†ã€‚

æœ¬æµ‹è¯•æ–‡ä»¶é€šè¿‡é€’å½’è®¡ç®— Fibonacci æ•°åˆ—çš„ç¤ºä¾‹å‡½æ•°ï¼ŒéªŒè¯äº† TaskManager åœ¨ **å•çº¿ç¨‹ï¼ˆserialï¼‰**ã€**å¤šçº¿ç¨‹ï¼ˆthreadï¼‰**ã€**å¤šè¿›ç¨‹ï¼ˆprocessï¼‰** ä¸ **å¼‚æ­¥ï¼ˆasyncï¼‰** å››ç§æ‰§è¡Œæ¨¡å¼ä¸‹çš„æ­£ç¡®æ€§ã€ç¨³å®šæ€§ä¸æ€§èƒ½è¡¨ç°ã€‚

---

## ğŸ”¹ test_manager()

æµ‹è¯• **TaskManager** åœ¨åŒæ­¥æ‰§è¡Œç¯å¢ƒä¸­çš„è¿è¡Œè¡Œä¸ºã€‚

- **ä»»åŠ¡å‡½æ•°**ï¼š`fibonacci(n)`ï¼ˆé€’å½’è®¡ç®—ç¬¬ n ä¸ª Fibonacci æ•°ï¼‰
- **è¿è¡Œæ¨¡å¼**ï¼šå•çº¿ç¨‹ã€çº¿ç¨‹æ± ã€å¤šè¿›ç¨‹ï¼ˆé€šè¿‡ `manager.test_methods()` è‡ªåŠ¨æµ‹è¯•ä¸‰ç§æ¨¡å¼ï¼‰
- **æµ‹è¯•ç‰¹æ€§**ï¼š
  - è¾“å…¥æ•°æ®åŒ…å«éæ³•å€¼ï¼ˆ`0`ã€`None`ã€ç©ºå­—ç¬¦ä¸²ï¼‰ï¼Œç”¨äºéªŒè¯å¼‚å¸¸æ•è·ä¸é‡è¯•é€»è¾‘ï¼›
  - è®¾ç½® `max_retries=1`ï¼Œå¹¶å…è®¸å¯¹ `ValueError` å¼‚å¸¸è¿›è¡Œé‡è¯•ï¼›
  - å¯ç”¨è¿›åº¦æ¡æ˜¾ç¤ºä¸æ—¥å¿—è®°å½•ã€‚
- **ä¸»è¦éªŒè¯ç‚¹**ï¼š
  1. å„æ‰§è¡Œæ¨¡å¼ä¸‹ä»»åŠ¡è°ƒåº¦ä¸è®¡æ•°é€»è¾‘æ˜¯å¦ä¸€è‡´ï¼›
  2. å¼‚å¸¸ä»»åŠ¡èƒ½å¦è¢«æ­£ç¡®è¯†åˆ«ä¸é‡è¯•ï¼›
  3. `test_methods()` æ˜¯å¦èƒ½å‡†ç¡®ç»Ÿè®¡ä¸åŒæ¨¡å¼ä¸‹çš„æ‰§è¡Œæ—¶é—´ä¸æ€§èƒ½å·®å¼‚ã€‚

## ğŸ”¹ test_manager_async()

æµ‹è¯• TaskManager åœ¨å¼‚æ­¥æ¨¡å¼ä¸‹çš„è¡Œä¸ºã€‚

- **ä»»åŠ¡å‡½æ•°**ï¼š`fibonacci_async(n)`ï¼ˆé€’å½’è®¡ç®—çš„å¼‚æ­¥ç‰ˆæœ¬ï¼‰
- **æ‰§è¡Œæ¨¡å¼**ï¼š`async`ï¼ˆåç¨‹å¹¶å‘æ‰§è¡Œï¼‰
- **ä»»åŠ¡ç‰¹æ€§**ï¼š
  - ä¸åŒæ­¥æµ‹è¯•ç›¸åŒçš„æ•°æ®è¾“å…¥ä¸é”™è¯¯è®¾è®¡ï¼›
  - ä½¿ç”¨ `await manager.start_async()` å¯åŠ¨ä»»åŠ¡ï¼›
  - è®°å½•æ•´ä¸ªä»»åŠ¡æ‰¹æ¬¡çš„æ€»æ‰§è¡Œæ—¶é—´ã€‚
- **ä¸»è¦éªŒè¯ç‚¹**ï¼š
  1. å¼‚æ­¥ä»»åŠ¡èƒ½å¦åœ¨é«˜å¹¶å‘ä¸‹æ­£ç¡®å®Œæˆï¼›
  2. å¼‚å¸¸æ•è·ä¸é‡è¯•æœºåˆ¶æ˜¯å¦åœ¨åç¨‹ç¯å¢ƒä¸‹æ­£å¸¸ï¼›
  3. å¼‚æ­¥æ‰§è¡Œç›¸å¯¹äºåŒæ­¥æ‰§è¡Œçš„æ€§èƒ½å¯¹æ¯”ã€‚

---

è¿è¡Œæ–¹å¼ï¼š
```bash
pytest tests/test_manage.py
```

æˆ–å•ç‹¬è¿è¡Œå¼‚æ­¥æµ‹è¯•ï¼š

```bash
pytest tests/test_manage.py::test_manager_async
```

# test_nodes.py

è¯¥æ–‡ä»¶ä¸»è¦ç”¨äºæµ‹è¯•[task_nodes.py](..\src\celestialflow\task_nodes.py)ä¸­å®šä¹‰çš„ä¸¤ä¸ªç‰¹æ®ŠèŠ‚ç‚¹ `TaskSplitter` ä¸ `TaskRedisTransfer`ï¼Œä¸¤è€…éƒ½ç»§æ‰¿è‡ª `TaskManager`ã€‚

`TaskSplitter`ç”¨äºå°†è¿­ä»£å™¨å½¢å¼çš„å¤šä¸ªä»»åŠ¡æ•°æ®(List[Task])æ‹†æˆå•ç‹¬ä»»åŠ¡(Task)ä¼ ç»™ä¸‹æ¸¸ï¼Œå› æ­¤åœ¨ Web é¡µé¢å¯ä»¥çœ‹åˆ° `TaskSplitter` ä¸‹æ¸¸è·å–çš„æ•°æ®ä¼šæ¯” `TaskSplitter` å¤„ç†æˆåŠŸçš„æ•°æ®æ›´å¤šï¼› `TaskRedisTransfer` ç”¨äºå°†ä¼ å…¥çš„ä»»åŠ¡ä¼ ç»™ Redis, å¦‚æœæ­¤æ—¶å¼€å¯go_workerï¼Œgo_workerä¼šä» Redis ä¸­æ¥å—æ•°æ®å¹¶åœ¨å¤„ç†åå°†ç­”æ¡ˆä¼ å› Redisï¼Œä¹‹å`TaskRedisTransfer`å†æå–ç­”æ¡ˆå¹¶ä¼ ç»™ä¸‹æ¸¸ã€‚

å¯¹äºä¸¤èŠ‚ç‚¹æ›´è¯¦ç»†çš„æè¿°è¯·çœ‹[Src README.md](..\src\celestialflow\README.md)ã€‚

## test_splitter_0() ä¸ test_splitter_1()

è¿™ä¸¤ä¸ªæµ‹è¯•æ–‡ä»¶å¤„ç†çš„æ˜¯åŒä¸€ä¸ªGraphç»“æ„ï¼Œæ¨¡æ‹Ÿäº†ä¸€æ¬¡çˆ¬è™«è¡Œä¸ºï¼ŒåŒ…æ‹¬çˆ¬å–ç½‘é¡µæ–‡ä»¶ã€è®°å½•çˆ¬å–ä¿¡æ¯ã€å¤„ç†ç½‘é¡µä¿¡æ¯ã€ä¸‹è½½ç½‘é¡µä¸­çš„é¢å¤–å†…å®¹(å›¾ç‰‡è§†é¢‘ç­‰)åŒæ—¶åœ¨å½“å‰é¡µé¢è§£æå…¶ä»–éœ€è¦çˆ¬å–çš„é¡µé¢ã€‚

ä¸¤è€…ä¸åŒä¹‹å¤„åœ¨äºtest_splitter_0()ä½¿ç”¨test_methodsæµ‹è¯•äº†æ‰€æœ‰çš„è¿è¡Œæ¨¡å¼ï¼Œè¿™åœ¨æ·»åŠ æ–°ç‰¹æ€§æ—¶æ—¶æœ‰ç”¨çš„ï¼Œæ­£å¸¸åªéœ€è¦è¿è¡Œtest_splitter_1()ã€‚

## ğŸ”¹ test_splitter_2()

è¿™ä¸ªæµ‹è¯•å‡½æ•°æ¨¡æ‹Ÿäº†ä¸€ä¸ªç‰¹æ®Šçš„æƒ…å†µ: æœ‰æ—¶å€™è¾“å…¥rootèŠ‚ç‚¹çš„ä»»åŠ¡æ•°è¿‡å¤§, æ¯”å¦‚range(int(1e10)), é‚£ä¹ˆæ‰€æœ‰èŠ‚ç‚¹éƒ½ä¼šä¸€ç›´ç­‰å¾…, è¿™æ˜¯å› ä¸ºå½“å‰`task_graph.put_stage_queue`çš„è¿è¡Œæœºåˆ¶ã€‚ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜å¯ä»¥åœ¨æœ€åˆæ”¾ä¸€ä¸ª `TaskSplitter` èŠ‚ç‚¹, ç»™å®ƒä¼ è¢«åˆ—è¡¨æ‰“åŒ…çš„ä»»åŠ¡ç»„ï¼Œè¿™æ ·ä¸‹æ¸¸å°±å¯ä»¥ä¸æ–­æ¥å—å¹¶å¤„ç†ä¸Šæ¸¸çš„æ•°æ®ï¼Œå³ä¾¿æ•°æ®é‡éå¸¸åºå¤§(æ¯”å¦‚`range(int(1e8))`)ã€‚

è¿è¡Œè¿™ä¸ªæµ‹è¯•å‡½æ•°æ—¶å¯èƒ½å‡ºç°stage 2å·²ç»å¤„ç†æ‰€æœ‰ä»»åŠ¡ï¼Œä½†ç¨‹åºæ²¡æœ‰ä¸­æ­¢çš„æƒ…å†µï¼Œè¿™æ˜¯å› ä¸º `task_logging` è®¾è®¡ä¸­æ—¥å¿—è®°å½•ä¸å†™å…¥æ–‡ä»¶æ˜¯åˆ†ç¦»çš„ï¼Œå½“stage 2å¤„ç†å®Œä»»åŠ¡æ—¶æ—¥å¿—è¿˜æ²¡æœ‰è¢«å…¨éƒ¨å†™å…¥æ–‡ä»¶ï¼Œç­‰å¾…ç‰‡åˆ»å°±å¥½ã€‚

## ğŸ”¹ test_transfer_0()

è¿™ä¸ªæµ‹è¯•æ–‡ä»¶å¯¹æ¯”äº†è®¡ç®—fibonacciæ—¶ï¼Œç›´æ¥ç”¨pyè®¡ç®—ä¸ä½¿ç”¨Rediså¤–æ¥go_workerè®¡ç®—é—´çš„æ—¶é—´å·®å¼‚ã€‚ä»ç»“æœæ¥çœ‹ï¼Œå³ä¾¿Redisä¼ è¾“è€—è´¹äº†å¤§é‡æ—¶é—´ï¼Œä½†Goå¼ºå¤§çš„æ€§èƒ½ä¾æ—§è®©ä½¿ç”¨go_workeræˆä¸ºCPUå¯†é›†è®¡ç®—æ—¶çš„å¥½é€‰æ‹©ã€‚

éœ€è¦æ³¨æ„çš„æ˜¯, åœ¨è¿è¡Œ`test_transfer_*`ç³»å‡½æ•°æ—¶, éœ€è¦å…ˆå¯åŠ¨ Redis æœåŠ¡, ç„¶åè®¾ç½® `TaskRedisTransfer` ä¸­ Redis ç«¯å£ä¸èŠ‚ç‚¹åç§°(å¦‚è¿™é‡Œçš„ `GoFibonacci`)ã€‚

```python
class TaskRedisTransfer(
    worker_limit: int = 50,
    unpack_task_args: bool = False,
    host: str = "localhost",
    port: int = 6379,
    db: int = 0,
    fetch_timeout: int = 10,
    result_timeout: int = 10
)

redis_transfer.set_graph_context([], stage_mode="process", stage_name="GoFibonacci")
```

å†åœ¨[go_worker main.go](../go_worker/main.go)ä¸­é…ç½® Redis æ¥å£, ä¿è¯ä¼ å…¥ä¼ å‡ºåˆ—è¡¨çš„ key å€¼ä¸ `TaskRedisTransfer` çš„ stage_name ç›¸åŒã€‚åŒæ—¶åœ¨[go_worker processor.go](../go_worker/worker/processor.go)ä¸­é€‰æ‹©ä½ è¦ä½¿ç”¨çš„ Go å‡½æ•°, è¿™é‡Œæˆ‘ä»¬ä½¿ç”¨ worker.Fibonacciã€‚

```go
rdb := redis.NewClient(&redis.Options{
  Addr: "localhost:6379",
  DB:   0,
})

worker.StartWorkerPool(
  ctx,
  rdb,
  "GoFibonacci[_trans_redis]:input",  // Redis ä¸­ä»»åŠ¡è¾“å…¥çš„ List
  "GoFibonacci[_trans_redis]:output", // Redis ä¸­ç»“æœå†™å…¥çš„ Hash
  worker.ParseListTask,
  worker.Fibonacci,
  4,
)
```

ç„¶åè¿è¡Œ

```bash
make run_go_worker
```

go_workerå¯åŠ¨å¹¶å¼€å§‹ç›‘å¬ Redis é˜Ÿåˆ—, æ­¤æ—¶å¯ä»¥æ­£å¸¸è¿è¡Œpytestã€‚

## ğŸ”¹ test_transfer_1()

è¿™ä¸ªæµ‹è¯•æ–‡ä»¶æµ‹è¯•äº†ä¼ é€’å¤šå‚æ•°çš„æƒ…æ™¯ï¼ŒåŒæ—¶ä¹Ÿå¯ä»¥ç›´è§‚çœ‹å‡ºå¯¹äº`sum`è¿™ç§å‡ ä¹0è¿ç®—æ—¶é—´çš„å‡½æ•°ï¼Œä½¿ç”¨ Redis çš„é€šä¿¡æ¶ˆè€—ä¼šè¿œè¿œè¶…è¿‡Goé«˜æ€§èƒ½çœä¸‹çš„æ—¶é—´ã€‚

## ğŸ”¹ test_transfer_2()

è¿™ä¸ªæµ‹è¯•å‡½æ•°æµ‹è¯•äº†è¿›è¡Œç½‘ç»œè¯·æ±‚å¹¶ä¸‹è½½æ•°æ®æ—¶ä½¿ç”¨pythonåŸç”Ÿå‡½æ•°ä¸go_workerçš„å·®è·ã€‚

# test_structur.py

è¯¥æ–‡ä»¶ä¸»è¦ç”¨äºæµ‹è¯•[task_structure.py](..\src\celestialflow\task_structure.py)ä¸­é¢„è®¾çš„å‡ ç§å›¾ç»“æ„ï¼ŒåŒ…æ‹¬ä½œä¸ºæ— ç¯å›¾(DAG)çš„:

- TaskChain: æ‰€æœ‰èŠ‚ç‚¹ä¸²è”
- TaskCross: Graph åˆ†ä¸ºå¤šå±‚, æ¯ä¸€å±‚æœ‰å¤šä¸ªèŠ‚ç‚¹ã€‚æ¯ä¸€å±‚å†…éƒ¨èŠ‚ç‚¹äº’ä¸ç›¸è¿, åŒæ—¶é“¾æ¥ä¸‹ä¸€å±‚æ‰€æœ‰èŠ‚ç‚¹ã€‚
- TaskGrid: èŠ‚ç‚¹æˆç½‘æ ¼çŠ¶, ä»å·¦ä¸Šè§’çš„èŠ‚ç‚¹å¼€å§‹, æ¯ä¸€ä¸ªèŠ‚ç‚¹ä¸ä¸‹/å³ä¾§èŠ‚ç‚¹ç›¸è¿ã€‚

ä½œä¸ºæœ‰ç¯å›¾çš„:

- TaskLoop: ç±»ä¼¼TaskChain. åªæ˜¯é¦–ä½ç›¸è¿ã€‚
- TaskWheel: åœ¨TaskLoopçš„åŸºç¡€ä¸Šå­˜åœ¨ä¸€ä¸ªä¸­å¿ƒèŠ‚ç‚¹, ä¸­å¿ƒèŠ‚ç‚¹è¿å‘å…¶ä»–æ¯ä¸€ä¸ªèŠ‚ç‚¹ã€‚
- TaskComplete: å®Œå…¨å›¾, æ‰€æœ‰èŠ‚ç‚¹ä¸¤ä¸¤ç›¸è¿ã€‚

å¯¹äºç»“æ„è¯¦ç»†çš„æè¿°è¯·çœ‹[Src README.md](..\src\celestialflow\README.md)ã€‚

é™¤äº† `task_structure.py` ä¸­é¢„è®¾çš„å‡ ç§ç»“æ„, è¿˜åŒ…æ‹¬ç±»ä¼¼:

- forest: å¤šä¸ªäº’ä¸ç›¸å…³çš„ Tree çŠ¶ç»“æ„, ç”¨ TaskGraph å®ç°
- star: ä¸€ä¸ªrootèŠ‚ç‚¹æŒ‡å‘å¤šä¸ªäº’ä¸å…³è”çš„èŠ‚ç‚¹, ç”¨TaskCrosså®ç°
- fanin: å¤šä¸ªrootèŠ‚ç‚¹æŒ‡å‘ä¸€ä¸ªèŠ‚ç‚¹, ç”¨TaskCrosså®ç°

